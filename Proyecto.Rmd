---
title: "Proyecto de Contingencias de Vida I"
author: 
  - Estudiantes
  - Erick Venegas Espinoza - C09319
  - Eduardo López Corella - C24343 
  - Gerard Gabert Hidalgo - B93096
  - Javier Hernández Navarro - C13674
  - Juan Pablo Morgan Sandí - C15319
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    default_style: "dark"
    downcute_theme: "chaos"
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)

source('code/setup.R')
```


## Primer ejercicio

### Punto A

```{r}
  tablas_activos <- proyeccion_demografica_activos(base_empleados, tablas_supen)
```
llamamos es script con los gráficos.
```{r}
source('code/graficos_activos.R')
```

#### Caso hombres

```{r}
fig_hombres_vivos_activos
```
#### Caso mujeres
```{r}
fig_mujeres_vivas_activas
```

### Punto B
```{r,echo=FALSE}
source('code/Proyecciones_demograficas_pensionados.R')
px <- px_acum(ABC, SUPEN)
proy_poblacion <- calcular_poblacion_viva(px, proy_poblacion)
proy_poblacion_muerta <- proy_poblacion
proy_poblacion_muerta$poblacion_mujeres <- 228 - proy_poblacion$poblacion_mujeres
proy_poblacion_muerta$poblacion_hombres <- 272 - proy_poblacion$poblacion_hombres
proy_pensionados_vivos <- calcular_pensionados_vivos(px, proy_pensionados_vivos)
proy_pensionados_muertos <- calcular_pensionados_muertos(px, proy_pensionados_muertos)
```

```{r,echo=FALSE}
# Crear el df para las proyecciones de pensionados vivos
proy_vivos <- data.frame(
  Año = 2024:2120,
  proy_vivas_mujeres = proy_pensionados_vivos$poblacion_mujeres,
  proy_vivos_hombres = proy_pensionados_vivos$poblacion_hombres
)

# Grafico interactivo
fig_pensionados_vivos <- plot_ly(proy_vivos, x = ~Año) %>%
  add_lines(y = ~proy_vivas_mujeres, name = 'Mujeres', line = list(color = '#FFA0F5')) %>%
  add_lines(y = ~proy_vivos_hombres, name = 'Hombres', line = list(color = '#92CFFF')) %>%
  layout(
    title = "Proyección Demográfica para Pensionados Vivos acumulados",
    xaxis = list(title = 'Año'),
    yaxis = list(title = 'Personas'),
    legend = list(title = list(text = 'Tipo de Pensionados Vivos:       '), orientation = 'h', xanchor = 'center', x = 0.5)
  )

fig_pensionados_vivos
```


### Punto C

#### Caso hombres 
```{r}
fig_hombres_muertes_activos
```
#### Caso mujeres
```{r}
fig_mujeres_muertes_activas
```


### Punto D
```{r, echo=FALSE}
# Crear el df para las proyecciones de pensionados muertos
proy_muertos <- data.frame(
  Año = 2024:2120,
  proy_muertas_mujeres = proy_pensionados_muertos$poblacion_mujeres,
  proy_muertos_hombres = proy_pensionados_muertos$poblacion_hombres
)

# Grafico interactivo
fig_muertos <- plot_ly(proy_muertos, x = ~Año) %>%
  add_lines(y = ~proy_muertas_mujeres, name = 'Mujeres', line = list(color = '#931986')) %>%
  add_lines(y = ~proy_muertos_hombres, name = 'Hombres', line = list(color = '#193B7B')) %>%
  layout(
    title = "Proyección Demográfica para Pensionados Muertos acumulados",
    xaxis = list(title = 'Año'),
    yaxis = list(title = 'Personas'),
    legend = list(title = list(text = 'Tipo de Pensionados Muertos:          '), orientation = 'h', xanchor = 'center', x = 0.5)
  )

fig_muertos
```



### Punto E
Para esta sección, se toman las proyecciones demográficas ya hechas anteriormente.

En primer lugar, creamos las tablas en cuestión que nos ayudarán a graficar.
```{r}
tablas_proy_fin <- proyeccion_financiera(tablas_activos, inflacion =  0.03)
```

```{r}
fig_proy_financiera <- plot_ly(tablas_proy_fin, x = ~Annos) %>%
  add_lines(y = ~Total, name = 'Proyeccion', line = list(color = '#698B69')) %>%
  layout(
    title = "Proyeccion financiera de activos vivos según el año",
    xaxis = list(title = 'Edad'),
    yaxis = list(title = 'Personas'),
    legend = list(title = list(text = 'Estado'), orientation = 'h', xanchor = 'center', x = 0.5)
  )

fig_proy_financiera
```



### Punto f
```{r}
Proyeccion_beneficios_muerte_pensionados <- Proyeccion_financiera_muerte_pensionados(proy_pensionados_muertos = proy_pensionados_muertos, suma_asegurada_pensionados = 1000000)

fig_proy_finan_muerte_pen <- plot_ly(Proyeccion_beneficios_muerte_pensionados, x = ~Anno) %>%
  add_lines(y = ~beneficio_muerte, name = 'Proyeccion', line = list(color = '#698B69')) %>%
  layout(
    title = "Proyeccion de los beneficios por muerte para pensionados según el año",
    xaxis = list(title = 'Año'),
    yaxis = list(title = 'Cantidad de Dinero'),
    legend = list(title = list(text = 'Estado'), orientation = 'h', xanchor = 'center', x = 0.5)
  )

fig_proy_finan_muerte_pen

```

### Punto g
```{r}
Proyeccion_pension <- Proyeccion_financiera_pension(proy_pensionados_vivos = proy_pensionados_vivos, pension_mensual = 300000)

fig_proy_financiera_pension <- plot_ly(Proyeccion_pension, x = ~Anno) %>%
  add_lines(y = ~anualidad, name = 'Proyeccion', line = list(color = '#698B69')) %>%
  layout(
    title = "Proyeccion del pago de pensiones según el año",
    xaxis = list(title = 'Año'),
    yaxis = list(title = 'Cantidad de Dinero'),
    legend = list(title = list(text = 'Estado'), orientation = 'h', xanchor = 'center', x = 0.5)
  )

fig_proy_financiera_pension
```

### Punto h
Estas son las primas para cada empleado
```{r}
Primas<-Calcula_prima_individuales(base_empleados,tablas_supen,5000000,1000000,300000)

#Base de empleados de combinaciones únicas 
base_unicas<- unico(base_empleados)

#Primas para empleados 
Primas_unicas <- Calcula_prima_individuales(base_unicas,tablas_supen,5000000,1000000,300000)
Primas_unicas <- Primas_unicas%>%
                  mutate(Sexo = if_else(Sexo == 1,'Hombre', 'Mujer')) %>%
                  select(-c(`anualidad`,`beneficios`))

```

### Punto i
Para la prima nivelada, se toman la suma de las esperanzas de los beneficios futuros y se divide por la suma de las esperanza del 
valor presente de las primas futuras, dando como resultado la prima nivelada anual.
```{r}
Prima_nivelada <- (sum(Primas$beneficios) / sum(Primas$anualidad) )

print(Prima_nivelada)
ggplot(Primas, aes(x = log(Primas))) +
  geom_histogram(bins = 20, fill = "blue", color = "black") +
  geom_vline(xintercept = log(Prima_nivelada), color = "red", linetype = "dashed", size = 1) +
  geom_text(aes(x = log(Prima_nivelada), y = -Inf, label = "Log prima nivelada"), 
            color = "red", hjust = -0.2, vjust = -0.5) +
  labs(title = "Histograma de Primas a Pagar", x = "logaritmo primas", y = "Frecuencia") +
  theme_minimal()

```

### Punto j

Dado que la idea de este ejercicio es reducir las primas un 10%, calculo cuál es la suma que representa el 90% de las primas originales,
para acercarnos a ellas.
```{r}
#Calcula cuánto es el 90% de las primas obtenidas
Primas_90_porciento <- data.frame(Empleado = Primas$Empleado,
                                  Menos_10_porciento = (Primas$Primas)*0.9)
```

La primera alternativa para reducir la prima 10%:
```{r}
# Se calculan primas con:
# Suma asegurada de 5 millones durante el tiempo de ser empleado activo
# Suma asegurada de 5 millones durante pensión 
# Primer año de pensión con mensualidad de 266.200 colones
Primas1_menos_10 <- Calcula_prima_individuales(base_empleados,tablas_supen,5000000,5000000,266200)

#se usa regla de 3 para verificar que la nueva prima sea aproximadamente el 90% de la original
Verifica1_90_porciento = data.frame(original_90 = Primas_90_porciento$Menos_10_porciento, 
                                    editada = Primas1_menos_10$Primas, 
                                    porcentaje= (Primas1_menos_10$Primas / Primas$Primas) * 100)

#Imprime el porcentaje promedio que representan las nuevas primas de las originales
print(sum(Verifica1_90_porciento$porcentaje)/nrow(Verifica1_90_porciento))
```

La Segunda alternativa para reducir la prima 10%:
```{r}
# Se calculan primas con:
# Suma asegurada de 1 millón durante el tiempo de ser empleado activo
# Suma asegurada de 1 millón durante pensión 
# Primer año de pensión con mensualidad de 271.900 colones
Primas2_menos_10 <- Calcula_prima_individuales(base_empleados,tablas_supen,1000000,1000000,271900)

#se usa regla de 3 para verificar que la nueva prima sea aproximadamente el 90% de la original
Verifica2_90_porciento = data.frame(original_90 = Primas_90_porciento$Menos_10_porciento, 
                                    editada = Primas2_menos_10$Primas, 
                                    porcentaje= (Primas2_menos_10$Primas / Primas$Primas) * 100)

#Imprime el porcentaje promedio que representan las nuevas primas de las originales
print(sum(Verifica2_90_porciento$porcentaje)/nrow(Verifica2_90_porciento))
```

```{r}


tabla_para_graficar <- data.frame(Empleado = Primas$Empleado,
                                   original = Primas$Primas, 
                                   editada1 = Verifica1_90_porciento$editada, 
                                   editada2 = Verifica2_90_porciento$editada)

  fig_comparacion1 <- plot_ly(tabla_para_graficar, x = ~Empleado) %>%
  add_trace(y = ~original, name = 'Original', type = 'bar', marker = list(color = '#92CFFF')) %>%
  add_trace(y = ~editada1, name = 'Opción 1 (90% de original)', type = 'bar', marker = list(color = '#193B7B')) %>%
  layout(
    title = "Comparación de la reducción de la 'Opción 1' con el original",
    xaxis = list(title = 'Empleado'),
    yaxis = list(title = 'Prima reducida'),
    barmode = 'group',
    legend = list(x = 0, y = 1, bgcolor = "white", bordercolor = "black", borderwidth = 1),
    margin = list(l = 50, r = 50, b = 50, t = 50, pad = 4)
  )

fig_comparacion1
```

```{r}

fig_comparacion2 <- plot_ly(tabla_para_graficar, x = ~Empleado) %>%
  add_trace(y = ~original, name = 'Original', type = 'bar', marker = list(color = '#92CFFF')) %>%
  add_trace(y = ~editada2, name = 'Opción 2 (90% de original)', type = 'bar', marker = list(color = '#193B7B')) %>%
  layout(
    title = "Comparación de la reducción de la 'Opción 2' con el original",
    xaxis = list(title = 'Empleado'),
    yaxis = list(title = 'Prima reducida'),
    barmode = 'group',
    legend = list(x = 0, y = 1, bgcolor = "white", bordercolor = "black", borderwidth = 1),
    margin = list(l = 50, r = 50, b = 50, t = 50, pad = 4)
  )

fig_comparacion2

```

```{r}

```

